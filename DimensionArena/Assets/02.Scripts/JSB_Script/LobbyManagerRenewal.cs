using System.Collections;
using System.Collections.Generic;
using Photon.Pun;
using Photon.Realtime;
using UnityEngine.UI;
using UnityEngine;
using UnityEngine.SceneManagement;
using TMPro;


// Test
using Firebase;
using Firebase.Database;
//

public enum MODE
{
    MODE_SURVIVAL,
    MODE_FREEFALLALL,
    MODE_TEAMDEATHMATCH,
    MODE_SUPERSTAR,
    MODE_TRAINING,
    MODE_END
}

public class LobbyManagerRenewal : MonoBehaviourPunCallbacks
{
    public static LobbyManagerRenewal Instance;

    [SerializeField] public TextMeshProUGUI loadText;

    //private string playerName = "Guest";
    //public string PlayerName { get { return playerName; } }

    
    // Survival , FreeforAll , TeamDeathMatch , SuperStar
    private string[] modeRoomNames = { "SV", "FF", "TD", "SS" };

    private List<Dictionary<string,RoomInfo>> rooms = new List<Dictionary<string, RoomInfo>>();
    
    public MODE playMode;

    [SerializeField] private int leastStartPlayer = 4;
    public int LeastStartPlayer { get { return leastStartPlayer; } }
    [SerializeField] private int maxStartPlayer = 8;
    public int MaxStartPlayer { get { return maxStartPlayer; } }

    [SerializeField] private List<string> playersName;

    private bool isWillStartGame = false;
    public bool IsWillStartGame { get { return isWillStartGame; } }


    //Test 
    [SerializeField] Dictionary<string, PlayerData> playerDatas = new Dictionary<string, PlayerData>();

    private void Awake()
    {
        if (null == Instance)
        {
            Instance = this;
            DontDestroyOnLoad(Instance);
        }
        else
            Destroy(this.gameObject);
    }


    // Start is called before the first frame update
    void Start()
    {
        PhotonNetwork.NickName = FirebaseDB_Manager.Instance.PlayerNickName;
        for (int i = (int)MODE.MODE_SURVIVAL; i < (int)MODE.MODE_END; ++i)
        {
            rooms.Add(new Dictionary<string, RoomInfo>());
        }

        loadText.text = "서버 접속 시도중...";
        // 서버에 접속 시도
        PhotonNetwork.ConnectUsingSettings();

    }
    public override void OnConnectedToMaster()
    {
        loadText.text = "서버 로비 접속중...";
        PhotonNetwork.JoinLobby();
    }
    public override void OnJoinedLobby()
    {
        Debug.Log("로비 접속 성공");

        loadText.text = "서버 접속 성공";
        
        /*if(isReconnect)
        {
            PhotonNetwork.NickName = playerName;
            isReconnect = false;
            return;
        }*/
        //playerName = MakeRandNickname();
        LoadingSceneController.Instance.LoadScene("Lobby_Main");
    }

    /*private string MakeRandNickname()
    {
        loadText.text = "랜덤 이름 생성중...";
        return FirebaseDB_Manager.Instance.RegisterDataBase(loadText);
    } */

    [PunRPC]
    public void PlayerNameAdd(string name)
    {
        playersName.Add(name);
    }

    // 해당 함수는 로비에 돌아갔을 시 자동적으로 호출되는 함수이며 , 로비 내부에서는 갱신을 할 수 없다.
    // -> 그럼 이거 로비에 둘 다 있을 때 방을 만들면 호출이 되는건가..;;
    public override void OnRoomListUpdate(List<RoomInfo> roomList)
    {
        base.OnRoomListUpdate(roomList);
        if(PhotonNetwork.IsMasterClient)
            photonView.RPC("SetUpRoomList",RpcTarget.All, roomList);
        SetUpRoomList(roomList);
        //rooms[(int)playMode] = roomList;
    }

    // 룸은 2글자로 밖에 관리를 못한다 즉 룸 앞의 이름이 절대 겹쳐서는 안된다
    [PunRPC]
    private void SetUpRoomList(List<RoomInfo> roomList)
    {
        string roomName = "";
        foreach(RoomInfo info in roomList)
        {
            roomName += info.Name[0].ToString() + info.Name[1].ToString();
            switch(roomName)
            {
                case "SV":
                    rooms[(int)MODE.MODE_SURVIVAL].Add(info.Name,info);
                    break;
                case "FF":
                    rooms[(int)MODE.MODE_FREEFALLALL].Add(info.Name, info);
                    break;
                case "TD":
                    rooms[(int)MODE.MODE_TEAMDEATHMATCH].Add(info.Name, info);
                    break;
                case "SS":
                    rooms[(int)MODE.MODE_SUPERSTAR].Add(info.Name, info);
                    break;
            }
        }
    }

    // 남은 룸이 있는지 확인하는 함수이다.
    private string CheckingRoom(MODE gameMode)
    {
        if (0 == rooms.Count)
            return "empty";
        foreach (Dictionary<string, RoomInfo> room in rooms)
        {
            foreach(string key in room.Keys)
            {
                if (room[key].IsOpen)
                {
                    return room[key].Name;
                }
            }
        } 
        return "empty";
    }

    private string GetNewRoomName()
    {
        int roomCount = 0;
        int playerCount = 0;
        for(int i = (int)MODE.MODE_SURVIVAL; i < (int)MODE.MODE_END; ++i)
        {
            roomCount += rooms[i].Count;
              foreach(string key in rooms[i].Keys)
            {
                playerCount += rooms[i][key].PlayerCount;
            }
            //for(int j = 0; j < rooms[i].Count;++j)
            //    playerCount += rooms[i][j].PlayerCount;
        }


        // 최소한의 방이 시작되는 조건이 4명 임으로
        if(15 < playerCount && 4 < roomCount)
            return "error";

        switch (playMode)
        {
            case MODE.MODE_SURVIVAL:
                return modeRoomNames[(int)MODE.MODE_SURVIVAL] + (rooms[(int)MODE.MODE_SURVIVAL].Count + 1).ToString();
            case MODE.MODE_FREEFALLALL:
                return modeRoomNames[(int)MODE.MODE_FREEFALLALL] + (rooms[(int)MODE.MODE_FREEFALLALL].Count + 1).ToString();
            case MODE.MODE_TEAMDEATHMATCH:
                return modeRoomNames[(int)MODE.MODE_TEAMDEATHMATCH] + (rooms[(int)MODE.MODE_TEAMDEATHMATCH].Count + 1).ToString();
            case MODE.MODE_SUPERSTAR:
                return modeRoomNames[(int)MODE.MODE_SUPERSTAR] + (rooms[(int)MODE.MODE_SUPERSTAR].Count + 1).ToString();
            default:
                return "error";
        }
    }

    public void Reconnect()
    {
        if(PhotonNetwork.IsConnected == false)
            PhotonNetwork.ConnectUsingSettings();
    }

    public void EnterTrainingMode()
    {
        if (playMode == MODE.MODE_TRAINING)
        {
            SceneManager.LoadScene("OfflineMode");
            return;
        }
    }

    public void JoinOrCreateRoom(MODE gameMode)
    {
        FirebaseDB_Manager.Instance.IsInGame = true;    

        playMode = gameMode;
        string roomName = CheckingRoom(gameMode);
        if (roomName == "empty")
        {
            // 임시로 방 생성은 일정한 이름으로 만들어 놨음
            string newRoomName = GetNewRoomName();
            bool roomMake = PhotonNetwork.CreateRoom(newRoomName, new RoomOptions { MaxPlayers = 8 }, null);
            if(!roomMake)
            {
                // 방 생성 실패

            }
        }
        else
            PhotonNetwork.JoinRoom(roomName);
    }
    /*public void ChangeNickNmae(string name)
    {
        
        playerName = name;
        PhotonNetwork.NickName = playerName;

    }*/

    public override void OnJoinRoomFailed(short returnCode, string message)
    {
        Debug.Log("접속실패");
    }
    public override void OnJoinedRoom()
    {
       
        //  아 방이 만들어졌는데 또 들어가는 오류인건가...
        //  JoinRandomRoom failed. Client is on GameServer (must be Master Server for matchmaking) and ready
        
        
        int playerCount = PhotonNetwork.CurrentRoom.PlayerCount;
        GameObject obj = GameObject.Find("MatchState");

        obj.GetComponent<MatchStateText>().RefreshTextAllClient(playerCount, maxStartPlayer);

        if (leastStartPlayer <= PhotonNetwork.CurrentRoom.PlayerCount)
        {
            isWillStartGame = true;
            PhotonNetwork.CurrentRoom.IsOpen = false;
            photonView.RPC("PlayStart", RpcTarget.All);
            // 게임이 시작했으면 방을 닫는다. -> 방을 닫고 씬을 로드해야지 댕청아
            //PhotonNetwork.CurrentRoom.IsOpen = false;
        }
    }

    public bool TryGetOutRoom()
    {
        if(false == PhotonNetwork.InRoom || true == PhotonNetwork.LeaveRoom())
            return true;
        else
            return false;
    }

    [PunRPC]
    private void PlayStart()
    {
        switch(playMode)
        {
            case MODE.MODE_SURVIVAL:
                PhotonNetwork.LoadLevel("Prototype");
                break;
            
        }
    }

}
